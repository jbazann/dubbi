---
import "@s/global.css"
import "@s/colors.css"
import "@s/features.css"
import TtyInput from "@c/main-layout/TtyInput.astro";
import { ttyCurrentPageId } from "@lib/ids";
---

<div class="tty-container">		
    <main class="contents">
        <TtyInput transition:persist/>
        <div id={ttyCurrentPageId} class="current-page-container" data-tty-page>
            <slot />
        </div>
    </main>
    <section id="tty-history" class="history-container" transition:persist>
        <template id="tty-history-template" >
            <div class="history-entry">
            </div>
        </template>
    </section>
</div>	

<style>

	.current-page-container : {
		background-color: var(--color-foreground);
	}
	
	.history-container {
		display: flex;
		flex-direction: column-reverse;

		.history-entry {
			display: block;
			/* opacity: 72%; */
	
			&:hover {
				opacity: 1;
			}
		}
	}

	.tty-container {
		display: flex;
		flex-direction: column-reverse;
		position: relative;
		width: 100%;
		min-height: fit-content;
		margin-top: var(--tty-top-margin);
		margin-bottom: var(--content-area-bottom-margin);
		contain: layout;
	}

</style>

<script>
	import { dispatch, newRewireEvent, newHistoryPushEvent, newScrollToBottomEvent, newScrollToPageEvent, newTtyFocusEvent, newStartLoadEvent, newEndLoadEvent, newHideInputEvent, newShowInputEvent, newUnmountEvent, newMountEvent } from "@lib/events"
	import { eventHandler, removeHandler } from "@lib/_events"
	import { log } from "@lib/log"
	import { ttyCurrentPageId, ttyScrollContainerId, ttyInputContainerId } from "@lib/ids"
	import { swapFunctions } from "astro:transitions/client"

	let pageContainer = document.getElementById(ttyCurrentPageId) as HTMLDivElement	
	let scrollContainer = document.getElementById(ttyScrollContainerId) as HTMLDivElement
	let ttyInContainer = document.getElementById(ttyInputContainerId) as HTMLDivElement

	eventHandler('astro:after-swap', (_event) => {
		scrollContainer = document.getElementById(ttyScrollContainerId) as HTMLDivElement
		pageContainer = document.getElementById(ttyCurrentPageId) as HTMLDivElement
		ttyInContainer = document.getElementById(ttyInputContainerId) as HTMLDivElement
		dispatch(newScrollToPageEvent())
	})

	const historyContainer = document.getElementById('tty-history') as HTMLDivElement
	const historyEntryTemplate = document.getElementById('tty-history-template') as HTMLTemplateElement

	eventHandler('tty:cls', (_event) => {
		requestAnimationFrame(() => {
			pageContainer.replaceChildren()
			historyContainer.replaceChildren()
		})
	})

	const pushHistory = () => {
		const elems = Array.from(pageContainer.children)
		const last = elems.at(-1)
		const historyEntry = historyEntryTemplate.content.cloneNode(true) as HTMLTemplateElement
		const historyEntryDiv = historyEntry.firstElementChild as HTMLDivElement
		last && pageContainer.replaceChildren(last)	
		// @ts-ignore some types for Cloudflare's HTMLRewriter, generated by Wrangler, overlap with browser APIs.
		historyEntryDiv.prepend(...elems.slice(0, -1))
		// @ts-ignore some types for Cloudflare's HTMLRewriter, generated by Wrangler, overlap with browser APIs.
		historyContainer.prepend(historyEntry)
	}

	eventHandler('astro:before-swap', (event) => {
		dispatch(newShowInputEvent())
		dispatch(newEndLoadEvent())
		const nd = (event as any).newDocument as HTMLDocument 
		(event as any).swap = () => {
			log("SWAPPING PAGE")
			const firstChild = pageContainer.firstElementChild as HTMLElement
			const newPageContainer = nd.body.querySelector(`#${ttyCurrentPageId}`) as HTMLElement
			swapFunctions.deselectScripts(nd)
			swapFunctions.swapRootAttributes(nd)
			swapFunctions.swapHeadElements(nd)
			const restoreFocusFunction = swapFunctions.saveFocus()
			swapFunctions.swapBodyElement(nd.body, document.body)
			// @ts-ignore some types for Cloudflare's HTMLRewriter, generated by Wrangler, overlap with browser APIs.
			newPageContainer.prepend(firstChild)
			restoreFocusFunction()
		}
	})

	const prepareSwap = () => {
		pushHistory()
		dispatch(newHideInputEvent())
		dispatch(newStartLoadEvent(), { context: "Prepare page swap." } as any )
	}

	eventHandler('astro:before-preparation', (_event) => {
		requestAnimationFrame(prepareSwap)
	})

	eventHandler('tty:history:push', (_event) => {
		requestAnimationFrame(pushHistory)
	})

	let pendingScroll = false
	const scrollToPage = () => {
		pageContainer.scrollIntoView(true)
		pendingScroll = false
	}
	const scrollToBottom = () => {
		scrollContainer.scrollTop = scrollContainer.scrollHeight - scrollContainer.clientHeight
		pendingScroll = false
	}
	eventHandler('tty:scroll:page', (_event) => {
		if (!pendingScroll && (scrollContainer.scrollTop !==  scrollContainer.scrollHeight - pageContainer.clientHeight - ttyInContainer.clientHeight)) {
			pendingScroll = true
			requestAnimationFrame(scrollToPage)
		}
	})
	eventHandler('tty:scroll:bottom', (_event) => {
		if (!pendingScroll && (scrollContainer.scrollTop !== scrollContainer.scrollHeight - scrollContainer.clientHeight)) {
			pendingScroll = true
			requestAnimationFrame(scrollToBottom)
		}
	})

	const insertPartial = (event: Event) => {
		return window.htmx.ajax(
			(event as CustomEvent).detail.method || 'post',
			(event as CustomEvent).detail.url,
			{
				event,
				target: `#${ttyCurrentPageId}`,
				swap: 'beforeend',
				values: (event as CustomEvent).detail.params
			}
		).then(() => {
			dispatch(newRewireEvent())
		}) 
	}
	eventHandler('tty:partial', (event) => {
		dispatch(newHistoryPushEvent())
		dispatch(newStartLoadEvent())
		insertPartial(event).then(() => {
			dispatch(newShowInputEvent())
			dispatch(newEndLoadEvent())
			dispatch(newScrollToPageEvent(), { context: "Insert partial." } as any )
			dispatch(newUnmountEvent())
			dispatch(newMountEvent())
		})
	})
	eventHandler('tty:partial:nopush', (event) => {
		dispatch(newStartLoadEvent())
		insertPartial(event).then(() => {
			dispatch(newShowInputEvent())
			dispatch(newEndLoadEvent())
			dispatch(newScrollToBottomEvent(), { context: "Insert partial." } as any )
			dispatch(newUnmountEvent())
			dispatch(newMountEvent())
		})
	})

	const ttyFocus = (event: Event) => {
		event.target === event.currentTarget && dispatch(newTtyFocusEvent())
	}
	
	eventHandler('sys:unmount', (_event?: Event) => {
		removeHandler('pointerup', ttyFocus, scrollContainer)
	})
	eventHandler('sys:mount', (_event?: Event) => {
		eventHandler('pointerup', ttyFocus, scrollContainer)
	})

</script>
