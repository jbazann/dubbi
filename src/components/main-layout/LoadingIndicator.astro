---
---

<template id="tty-loading-indicator-template">
    <span id="tty-loading-indicator"></span>
</template>

<script>
    import { eventHandler } from "@lib/_events"
    import { dispatch, newScrollToBottomEvent } from "@lib/events"
    import { ttyCurrentPageId } from "@lib/ids"
    import { err, log } from "@lib/log"


    let pageContainer = document.getElementById(ttyCurrentPageId) as HTMLDivElement
    !pageContainer && err(`Page container ${pageContainer} not found.`)

    const template = document.getElementById('tty-loading-indicator-template') as HTMLTemplateElement

    eventHandler('astro:after-swap', (_event) => {
        pageContainer = document.getElementById(ttyCurrentPageId) as HTMLDivElement
        !pageContainer && err(`Page container ${pageContainer} not found.`)
    })
    
    const symbols = ['—', '—', '\\', '|', '/', '—', '—', '/', '|', '\\']
    const next = (i: number) => (i + 1) % symbols.length
    let index = 0
    const spin = () => {
        span.textContent = symbols.at(index)!
        index = next(index)
    }
    const rafSpin = () => {
        requestAnimationFrame(spin)
    }
    
    const run = () => {
        log("Starting.", "LOADING INDICATOR")
        if (interval) clearInterval(interval)
        interval = setInterval(rafSpin, 1_000 / (symbols.length))
    }

    const stop = () => {
        interval && clearInterval(interval)
        log("Stopping.", "LOADING INDICATOR")
    }
    
    let span = (template.content.cloneNode(true) as Element).firstElementChild!
    let node: Node | null = null
    let interval: any
    const show = (event?: Event) => {
        requestAnimationFrame(() => {
        log("Showing.", "LOADING INDICATOR")
        node = pageContainer.appendChild(span)
        !(event as CustomEvent)?.detail?.preventScroll && dispatch(newScrollToBottomEvent())
        index = 0
        run()
    })
    }
    
    const _hide = () => {
        stop()
        log("Removing.", "LOADING INDICATOR")
        node && pageContainer.removeChild(node)
        node = null
    }
    const hide = (_event: Event) => {
        requestAnimationFrame(_hide)
    }

    eventHandler('tty:loading:start', show)
    eventHandler('tty:loading:end', hide)

</script>